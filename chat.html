<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>GPT3.5-Turbo</title>
  <!-- material design lite 的主题CSS -->
  <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.teal-light_blue.min.css">
  <!-- 引入Material Icons -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <!-- 高亮代码highlight.js的sublime高亮主题 -->
  <link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/monokai-sublime.min.css">
  <!-- 自定义CSS -->
  <link rel="stylesheet" href="css/hidden.css" />
</head>

<body>

  <body>
    <!-- Always shows a header, even in smaller screens. -->
    <div class="mdl-layout mdl-js-layout mdl-layout--fixed-header">
      <header class="mdl-layout__header">
        <div class="mdl-layout__header-row">
          <!-- Title -->
          <span class="mdl-layout-title">欢迎使用GPT3.5-Turbo</span>
          <!-- Add spacer, to align navigation to the right -->
          <div class="mdl-layout-spacer"></div>
          <!-- Navigation. We hide it in small screens. -->
          <nav class="mdl-navigation mdl-layout--large-screen-only">
            <a class="mdl-navigation__link" href="/resources/movies.php">电影</a>
            <a class="mdl-navigation__link" href="/resources/serial.php">电视剧</a>
            <a class="mdl-navigation__link" href="/resources/variety_show.php">综艺</a>
            <a class="mdl-navigation__link" href="/resources/books.php">书籍</a>
            <a class="mdl-navigation__link" href="/resources/chat.html">GPT3.5</a>
          </nav>
          <!-- 没有用的search button等你完善-->
          <div class="mdl-textfield mdl-js-textfield mdl-textfield--expandable
                                  mdl-textfield--floating-label mdl-textfield--align-right">
            <label class="mdl-button mdl-js-button mdl-button--icon" for="fixed-header-drawer-exp">
              <i class="material-icons">search</i>
            </label>
            <div class="mdl-textfield__expandable-holder">
              <input class="mdl-textfield__input" type="text" name="sample" id="fixed-header-drawer-exp">
            </div>
          </div>
        </div>
      </header>
      <div class="mdl-layout__drawer">
        <span class="mdl-layout-title">GPT3.5-Turbo</span>
        <nav class="mdl-navigation">
          <a class="mdl-navigation__link" href="/resources">
            <span class="material-icons">home</span>首页
          </a>
          <a class="mdl-navigation__link" href="/resources/movies.php">
            <span class="material-icons">movie</span>电影
          </a>
          <a class="mdl-navigation__link" href="/resources/serial.php">
            <span class="material-icons">live_tv</span>电视剧
          </a>
          <a class="mdl-navigation__link" href="/resources/variety_show.php">
            <span class="material-icons">sports_martial_arts</span>综艺
          </a>
          <a class="mdl-navigation__link" href="/resources/books.php">
            <span class="material-icons">auto_stories</span>书籍
          </a>
          <a class="mdl-navigation__link" href="https://github.com/dongguaguaguagua/getenjoyment">
            <!-- 20-(24-17)=13 -->
            <svg viewBox="0 0 24 24" width="17" height="17" style="font-size: small;padding-right: 19px;">
              <path fill="#878787"
                d="M12,0.4c-6.6,0-12,5.4-12,12c0,5.3,3.4,9.8,8.1,11.4c0.6,0.1,0.8-0.3,0.8-0.6c0-0.3,0-1,0-2c-3.3,0.7-4-1.6-4-1.6c-0.5-1.3-1.3-1.6-1.3-1.6c-1.1-0.7,0.1-0.7,0.1-0.7c1.2,0.1,1.9,1.2,1.9,1.2c1.1,1.9,2.8,1.3,3.5,1c0.1-0.8,0.4-1.3,0.8-1.6c-2.9-0.3-6-1.4-6-6c0-1.3,0.5-2.3,1.2-3.1c-0.1-0.3-0.5-1.5,0.1-3c0,0,1-0.3,3.2,1.2c0.9-0.3,1.9-0.5,2.9-0.5s2,0.2,2.9,0.5c2.1-1.5,3.2-1.2,3.2-1.2c0.6,1.5,0.2,2.7,0.1,3c0.8,0.8,1.2,1.8,1.2,3.1c0,4.6-3.1,5.7-6,6c0.5,0.4,0.9,1.1,0.9,2.3c0,1.7,0,3,0,3c0,0.3,0.2,0.7,0.8,0.6c4.7-1.6,8.1-6.1,8.1-11.4C24,5.8,18.6,0.4,12,0.4z" />
            </svg>Github
          </a>
        </nav>
      </div>
      <main class="mdl-layout__content">
        <div id="conversation_container"></div>
        <div id="btnContainer" style="width: 200px;margin-left: auto;margin-right: auto;margin-top: 200px;">
          <button onclick="submit()" style="width: 100%;"
            class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect">
            generate
            <span class="material-icons">done_all</span>
          </button>
        </div>
      </main>
  </body>
  <!-- markdown-it -->
  <script src="https://cdn.jsdelivr.net/npm/markdown-it/dist/markdown-it.min.js"></script>
  <!-- 引入highlight.js来高亮代码 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
  <!-- jQuery框架 -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <!-- material design lite -->
  <script src="https://code.getmdl.io/1.3.0/material.min.js"></script>
  <script>
    var message = [[], [], []];
    const iconDict = { "user": "face", "assistant": "chat", "system": "settings", "error": "error", "comment": "edit_note" };
    var count = 0;
    const md = new markdownit({
      linkify: true, // Autoconvert URLs into links
      // typographer: true, // Enable smartypants and other typographic replacements
      // quotes: '“”‘’',
      highlight: function(str, lang) {
        if (lang && hljs.getLanguage(lang)) {
          try {
            return '<pre class="hljs"><code>' +
              hljs.highlight(lang, str, true).value +
              '</code></pre>';
          } catch (__) {}
        } else {
          return '<pre class="hljs"><code>' +
            hljs.highlightAuto(str).value +
            '</code></pre>';
        }
        return '<pre class="hljs"><code>' + md.utils.escapeHtml(str) + '</code></pre>';
      }
    });

    $(document).ready(function() {
      createBox("system", "This is a system prompt, double-click to edit me.", -1);
      createBox("user", "**This is where you put your questions, double-click to edit me.**", -1);
      createBox("assistant", "This is where answers generated, which supports [markdown](https://daringfireball.net/projects/markdown/).", -1);
    });

    function switchTo(element, index, boxClass) {
      const box = $("#box_id" + index);
      const btn = $("#headline_iconbtn_id" + index);
      const content = $("#content_id" + index);
      message[0][message[2].indexOf(String(index))] = boxClass;
      btn.html("<i class='material-icons'>" + iconDict[boxClass] + "</i>")
      box.removeClass("userBox");
      box.removeClass("systemBox");
      box.removeClass("assistantBox");
      box.removeClass("commentBox")
      box.removeClass("errorBox");
      box.addClass(boxClass + "Box");
      console.log(message);
    }

    function makeNonEditable(element) {
      const textarea = $("#" + element.id);
      const content = $("#content_id" + textarea.attr("index"));
      const i = message[2].indexOf(textarea.attr("index"));
      const text = textarea.val();
      const htmlStrinng = md.render(text);
      const div = $('<div>').attr({
        id: textarea.attr("id"),
        ondblclick: 'makeEditable(this)',
        index: textarea.attr("index"),
        hiddenText: text,
      }).html(htmlStrinng);
      message[1][i] = text;
      textarea.replaceWith(div);
      console.log(message);
    }

    function makeEditable(element) {
      const div = $("#" + element.id);
      const text = div.attr("hiddenText");
      const textarea = $('<textarea>').attr({
        id: div.attr("id"),
        index: div.attr("index"),
        onblur: 'makeNonEditable(this)',
        hiddenText: div.attr("hiddenText"),
      }).val(text).keydown(function() {
        //Auto-expanding textarea
        this.style.removeProperty('height');
        this.style.height = (this.scrollHeight + 10) + 'px';
      }).focus(function() {
        //Do this on focus, to allow textarea to animate to height...
        this.style.removeProperty('height');
        this.style.height = (this.scrollHeight + 10) + 'px';
      });
      div.replaceWith(textarea);
      textarea.focus();
    }

    function createBox(boxClass, text, atwhere) {
      const headline = $("<div>").attr({
        id: "headline_id" + count,
      }).addClass("head-line");
      // create icons
      const icon1 = $('<i>', {
        class: 'material-icons option-icons',
        text: 'face'
      })
      const icon2 = $('<i>', {
        class: 'material-icons option-icons',
        text: 'settings'
      })
      const icon3 = $('<i>', {
        class: 'material-icons option-icons',
        text: 'chat'
      })
      const icon4 = $('<i>', {
        class: 'material-icons option-icons',
        text: 'edit_note'
      })

      // create the button using the MaterialButton function

      const classBtn = $('<button>', {
        id: "headline_iconbtn_id" + count,
        class: 'mdl-button mdl-js-button mdl-button--icon'
      }).append($('<i>', {
        class: 'material-icons',
        text: iconDict[boxClass]
      }));
      const deleteBtn = $('<button>', {
        id: "deletebtn_id" + count,
        class: 'mdl-button mdl-js-button mdl-button--icon right-float-icons',
        onclick: 'deleteBox(' + count + ');'
      }).append($('<i>', {
        class: 'material-icons',
        text: "delete"
      }));
      const addBtn = $('<button>', {
        id: "addbtn_id" + count,
        class: 'mdl-button mdl-js-button mdl-button--icon right-float-icons',
        onclick: 'addBox(' + count + ');'
      }).append($('<i>', {
        class: 'material-icons',
        text: "add"
      }));

      // create the menu using the MaterialMenu function
      const menu = $('<ul>', {
        class: 'mdl-menu mdl-menu--bottom-left mdl-js-menu mdl-js-ripple-effect',
        for: "headline_iconbtn_id" + count,
      }).append(
        $('<li>').attr({
          'class': 'mdl-menu__item',
          'onclick': "switchTo(this, " + count + ", 'user');"
        }).text('User').prepend(icon1),
        $('<li>').attr({
          'class': 'mdl-menu__item',
          'onclick': "switchTo(this, " + count + ", 'system');"
        }).text('System').prepend(icon2),
        $('<li>').attr({
          'class': 'mdl-menu__item',
          'onclick': "switchTo(this, " + count + ", 'assistant');"
        }).text('Assistant').prepend(icon3),
        $('<li>').attr({
          'class': 'mdl-menu__item',
          'onclick': "switchTo(this, " + count + ", 'comment');"
        }).text('Comment').prepend(icon4),
      );
      // append the button and menu to the div with class "head-line"
      headline.append(classBtn, menu, addBtn, deleteBtn);
      // create content container
      const htmlStrinng = md.render(text);

      content = $('<div>').attr({
        id: 'content_id' + count,
        index: count,
        ondblclick: 'makeEditable(this)',
        hiddenText: text,
      }).html(htmlStrinng);
      // create the div box
      const box = $('<div>').attr({
        id: 'box_id' + count,
        index: count
      }).addClass("mdl-cell mdl-cell--12-col mdl-shadow--2dp")
        .addClass(boxClass + "Box");
      box.append(headline).append(content);
      if (atwhere == -1) {
        message[0].push(boxClass);
        message[1].push(text);
        message[2].push(String(count));
        $("#conversation_container").append(box);
      } else {
        message[0].splice(atwhere + 1, 0, boxClass);
        message[1].splice(atwhere + 1, 0, text);
        message[2].splice(atwhere + 1, 0, String(count));
        $("#box_id" + message[2][atwhere]).after(box);
      }
      componentHandler.upgradeDom();
      count++;
    }

    function submit() {
      const roles = message[0];
      const contents = message[1];
      const processedMsg = [];

      for (let i = 0; i < message[2].length; i++) {
        if (roles[i] === "user" || roles[i] === "system" || roles[i] === "assistant") {
          processedMsg.push({
            role: roles[i],
            content: contents[i]
          });
        }
      }
      console.log(JSON.stringify({
        'model': 'gpt-3.5-turbo',
        'messages': processedMsg,
      }));
      fetch('https://api.openai.com/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer sk-***',
          'Access-Control-Allow-Origin': '*',
        },
        body: JSON.stringify({
          'model': 'gpt-3.5-turbo',
          'messages': processedMsg,
        })
      }).then((response) => response.json()).then((result) => {
        assistantResponce = result.choices[0].message;
        console.log("get response successfully:\n", assistantResponce.content);
        createBox("assistant", assistantResponce.content, -1);
      }).catch((error) => {
        console.log("failed!")
        createBox("error", "NetWork Error! Please try it again.", -1);
        console.error(error);
      });
    }

    function addBox(index) {
      const i = message[2].indexOf(String(index));
      createBox("user", "*write something here*", i);
      console.log(message);
    }

    function deleteBox(index) {
      const i = message[2].indexOf(String(index));
      message[0].splice(i, 1);
      message[1].splice(i, 1);
      message[2].splice(i, 1);
      $("#box_id" + index).remove();
      console.log(message);
    }
  </script>

</html>

</html>
